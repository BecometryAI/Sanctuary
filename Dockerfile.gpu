# The Sanctuary - GPU Docker build (NVIDIA CUDA)
# Requires: NVIDIA Container Toolkit
# Build: docker build -f Dockerfile.gpu -t sanctuary:gpu .

# =============================================================================
# Stage 1: Builder
# =============================================================================
FROM nvidia/cuda:12.1-runtime-ubuntu22.04 AS builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-venv python3.11-dev python3-pip \
    build-essential git curl && rm -rf /var/lib/apt/lists/*

RUN python3.11 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

RUN pip install --no-cache-dir --upgrade pip wheel setuptools

# Install PyTorch with CUDA 12.1 support
RUN pip install --no-cache-dir torch torchvision torchaudio \
    --index-url https://download.pytorch.org/whl/cu121

WORKDIR /app
COPY pyproject.toml setup.py ./

RUN pip install --no-cache-dir . || \
    pip install --no-cache-dir \
    numpy transformers sentence-transformers langchain chromadb accelerate \
    bitsandbytes quart hypercorn httpx aiohttp "discord.py" python-dotenv pydantic

# =============================================================================
# Stage 2: Runtime
# =============================================================================
FROM nvidia/cuda:12.1-runtime-ubuntu22.04 AS runtime

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-venv libsndfile1 ffmpeg curl && \
    ln -s /usr/bin/python3.11 /usr/bin/python && \
    rm -rf /var/lib/apt/lists/*

RUN groupadd --gid 1000 sanctuary && \
    useradd --uid 1000 --gid sanctuary --shell /bin/bash --create-home sanctuary

COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

WORKDIR /app
COPY --chown=sanctuary:sanctuary . .

RUN mkdir -p /app/data/memories /app/data/chroma /app/data/checkpoints /app/data/logs && \
    chown -R sanctuary:sanctuary /app/data

USER sanctuary

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/app/sanctuary:/app \
    SANCTUARY_BASE_DIR=/app/data \
    SANCTUARY_CHROMA_DIR=/app/data/chroma \
    SANCTUARY_LOG_DIR=/app/data/logs \
    NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility

EXPOSE 8000

HEALTHCHECK --interval=60s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import mind; import torch; print(torch.cuda.is_available())" || exit 1

CMD ["python", "-m", "sanctuary.run_cognitive_core"]
